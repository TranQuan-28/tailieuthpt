<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kho Tài Liệu Học Tập</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar for table */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Animation for Modal */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-book-open text-2xl mr-2"></i>
                    <span class="font-bold text-xl">DocuShare</span>
                </div>
                <!-- Desktop Menu -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4" id="nav-container">
                        <!-- Nav Items will be injected here -->
                    </div>
                </div>
                <!-- Mobile Menu Button -->
                <div class="-mr-2 flex md:hidden">
                    <button onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2 rounded-md text-white hover:bg-blue-700 focus:outline-none">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3" id="mobile-nav-container">
                <!-- Mobile Nav Items injected here -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        
        <div class="bg-white rounded-lg shadow-md p-6 min-h-[500px]">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">Chọn môn học</h2>
                <div id="status-indicator" class="text-sm text-gray-500">Waiting for selection...</div>
            </div>

            <!-- Loader -->
            <div id="loader" class="hidden flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>

            <!-- Data Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 hidden" id="data-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Môn</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên File</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="table-body">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-12 text-gray-500">
                    <i class="fas fa-folder-open text-4xl mb-3 block"></i>
                    <p>Chưa có tài liệu cho môn này.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 text-center">
        <p>&copy; 2024 DocuShare. All rights reserved.</p>
    </footer>

    <!-- AD MODAL (The "Trap") -->
    <div id="ad-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4 relative text-center modal-enter-active">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Đang tải liên kết...</h3>
            <p class="text-gray-600 mb-6 text-sm">Vui lòng đóng quảng cáo để tiếp tục tải xuống.</p>
            
            <!-- The Big X Button -->
            <div class="flex justify-center">
                <button onclick="handleAdClick()" class="group rounded-full bg-red-100 p-4 hover:bg-red-200 transition duration-300 ring-4 ring-red-50 cursor-pointer">
                    <i class="fas fa-times text-4xl text-red-500 group-hover:scale-110 transition-transform duration-200"></i>
                </button>
            </div>
            <p class="mt-4 text-xs text-gray-400">Click X to close</p>
        </div>
    </div>

    <script>
        // CONFIGURATION
        // REPLACE THIS with your Google Apps Script Web App URL after deploying
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJHGKPmh8jn8Bp7Q4tTwINJzcfuN6N0uDJddQy8FcD7U9k3ejz4d6esBwSX03hpMju/exec'; 
        const AFFILIATE_LINK = 'https://google.com'; // Replace with your affiliate link
        const SUBJECTS = ["Toán", "Văn", "Anh", "Tin", "Sử", "Hóa"];

        // State
        let cachedData = null;
        let currentLinkToOpen = null;

        // --- MOCK DATA FOR PREVIEW (Remove this block when using real API) ---
        const MOCK_DATA = {
            "Toán": [
                { subject: "Toán", filename: "Đề thi Đại học 2023", link: "https://example.com/math1.pdf" },
                { subject: "Toán", filename: "Công thức Lượng giác", link: "https://example.com/math2.pdf" }
            ],
            "Văn": [
                { subject: "Văn", filename: "Phân tích Vợ Chồng A Phủ", link: "https://example.com/lit1.pdf" }
            ],
            "Anh": [],
            "Tin": [
                { subject: "Tin", filename: "Python cơ bản", link: "https://example.com/cs1.pdf" }
            ],
            "Sử": [],
            "Hóa": [
                { subject: "Hóa", filename: "Bảng tuần hoàn", link: "https://example.com/chem1.pdf" }
            ]
        };
        // --------------------------------------------------------------------

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            renderNav();
            // Default to first subject
            loadSubject(SUBJECTS[0]); 
        });

        // 1. Render Navigation
        function renderNav() {
            const navContainer = document.getElementById('nav-container');
            const mobileNavContainer = document.getElementById('mobile-nav-container');

            SUBJECTS.forEach(sub => {
                // Desktop
                const btn = document.createElement('button');
                btn.className = `nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition duration-150 ease-in-out`;
                btn.textContent = sub;
                btn.onclick = () => loadSubject(sub);
                btn.dataset.subject = sub;
                navContainer.appendChild(btn);

                // Mobile
                const mBtn = document.createElement('button');
                mBtn.className = `block w-full text-left px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700 text-white`;
                mBtn.textContent = sub;
                mBtn.onclick = () => { loadSubject(sub); toggleMobileMenu(); };
                mobileNavContainer.appendChild(mBtn);
            });
        }

        // 2. Fetch Data (Logic to switch between Mock and Real)
        async function fetchSheetData() {
            if (cachedData) return cachedData;

            // If no URL provided, use Mock Data (For Preview Purposes)
            if (!APPS_SCRIPT_URL) {
                console.log("No API URL provided, using MOCK DATA.");
                cachedData = MOCK_DATA;
                return cachedData;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const json = await response.json();
                cachedData = json;
                return json;
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Lỗi tải dữ liệu. Đang hiển thị dữ liệu mẫu.");
                cachedData = MOCK_DATA; // Fallback
                return cachedData;
            }
        }

        // 3. Load Subject Page
        async function loadSubject(subject) {
            // Update UI Active State
            document.querySelectorAll('.nav-btn').forEach(b => {
                if (b.dataset.subject === subject) {
                    b.classList.add('bg-blue-800', 'text-white');
                    b.classList.remove('text-blue-100');
                } else {
                    b.classList.remove('bg-blue-800', 'text-white');
                    b.classList.add('text-blue-100');
                }
            });

            document.getElementById('page-title').textContent = `Tài liệu môn: ${subject}`;
            document.getElementById('table-body').innerHTML = '';
            document.getElementById('data-table').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('status-indicator').textContent = "Đang tải dữ liệu...";

            const data = await fetchSheetData();
            
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('status-indicator').textContent = "Đã cập nhật";

            const subjectData = data[subject] || [];

            if (subjectData.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                renderTable(subjectData);
            }
        }

        // 4. Render Table
        function renderTable(files) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            const table = document.getElementById('data-table');
            
            files.forEach(file => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition duration-150";
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${file.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${file.filename}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="handleDownloadClick('${file.link}')" class="text-blue-600 hover:text-blue-900 flex items-center gap-2 font-bold">
                            <i class="fas fa-download"></i> Tải về
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            table.classList.remove('hidden');
        }

        // 5. CORE LOGIC: Affiliate Redirect System
        function handleDownloadClick(realLink) {
            // Check local storage
            const hasClickedBefore = localStorage.getItem(`visited_${realLink}`);

            if (hasClickedBefore) {
                // Second time: Open real link
                window.open(realLink, '_blank');
            } else {
                // First time: Show Trap Modal
                currentLinkToOpen = realLink;
                const modal = document.getElementById('ad-modal');
                modal.classList.remove('hidden');
            }
        }

        // Triggered when user clicks the "X" in the modal
        function handleAdClick() {
            if (!currentLinkToOpen) return;

            // 1. Mark as visited in LocalStorage
            localStorage.setItem(`visited_${currentLinkToOpen}`, 'true');

            // 2. Open Affiliate Link in new tab
            window.open(AFFILIATE_LINK, '_blank');

            // 3. Hide Modal
            document.getElementById('ad-modal').classList.add('hidden');
            
            // 4. Reset temp var
            currentLinkToOpen = null;
        }

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
    </script>
</body>

</html>
